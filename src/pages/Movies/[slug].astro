---
/**
 * Página dinámica para cada película
 * URL: /Movies/[slug]
 * Ejemplo: /Movies/the-dark-knight-2008
 */
import { ListMovies } from '../../data/MoviesDB';
import { getMovie, getMoviePeople, getMoviesFromLists, getImageUrl } from '../../services/apiTrakt';
import { enrichMoviesWithRatings } from '../../services/apiOMDB';
import Layout from '../../layouts/Layout.astro';
import IconIMDB from '../../components/Icons/IconIMDB.astro';
import IconRottenTomatoes from '../../components/Icons/IconRottenTomatoes.astro';
import IconMetacritic from '../../components/Icons/IconMetacritic.astro';
import IconPopcorn from '../../components/Icons/IconPopcorn.astro';
import IconTrakt from '../../components/Icons/IconTrakt.astro';

// Generar todas las rutas estáticas
export async function getStaticPaths() {
    const TRAKT_USERNAME = "auferoz";

    // Obtener todas las películas de todas las listas
    const allListsData = await getMoviesFromLists(TRAKT_USERNAME, ListMovies);
    const allMovies = allListsData.flatMap(list => list.movies);

    // Enriquecer con ratings externos
    const moviesWithRatings = await enrichMoviesWithRatings(allMovies);

    // Deduplicar por slug (una película puede estar en varias listas)
    const moviesBySlug = new Map();
    for (const movieData of moviesWithRatings) {
        const slug = movieData.movie?.ids?.slug;
        if (slug) {
            moviesBySlug.set(slug, movieData);
        }
    }

    // Generar paths
    const paths = await Promise.all(
        Array.from(moviesBySlug.entries()).map(async ([slug, movieData]) => {
            try {
                const [movie, people] = await Promise.all([
                    getMovie(slug),
                    getMoviePeople(slug),
                ]);

                return {
                    params: { slug },
                    props: {
                        movie,
                        people,
                        localData: {
                            yearViewed: movieData.yearViewed,
                            rank: movieData.rank,
                            listedAt: movieData.listedAt,
                            externalRatings: movieData.externalRatings,
                        },
                    },
                };
            } catch (error) {
                console.error(`Error fetching data for movie ${slug}:`, error);
                return {
                    params: { slug },
                    props: {
                        movie: null,
                        people: null,
                        localData: {
                            yearViewed: movieData.yearViewed,
                            rank: movieData.rank,
                            listedAt: movieData.listedAt,
                            externalRatings: movieData.externalRatings,
                        },
                    },
                };
            }
        })
    );

    return paths;
}

// Props de la página
interface Props {
    movie: any;
    people: any;
    localData: {
        yearViewed: number;
        rank?: number;
        listedAt?: string;
        externalRatings?: {
            imdb?: string | null;
            imdbVotes?: string | null;
            rottenTomatoes?: string | null;
            metascore?: string | null;
            popcornmeter?: string | null;
        } | null;
    };
}

const { movie, people, localData } = Astro.props;
const { yearViewed, rank, listedAt, externalRatings } = localData;

// Imágenes
const moviePoster = getImageUrl(movie?.images?.poster?.[0]);
const movieFanart = getImageUrl(movie?.images?.fanart?.[0]);
const movieLogo = getImageUrl(movie?.images?.logo?.[0]);
const movieBanner = getImageUrl(movie?.images?.banner?.[0]);

// Datos de la película
const title = movie?.title || 'Sin título';
const year = movie?.year;
const overview = movie?.overview || '';
const genres = movie?.genres || [];
const runtime = movie?.runtime;
const certification = movie?.certification;
const rating = movie?.rating?.toFixed(1);

// Formatear duración
const formatRuntime = (minutes: number | undefined) => {
    if (!minutes) return null;
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
};
const duration = formatRuntime(runtime);

// Formatear fecha de listedAt
const formatListedAt = (dateString: string | undefined) => {
    if (!dateString) return null;
    const date = new Date(dateString);
    const day = date.getDate().toString().padStart(2, '0');
    const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    return `${day} ${months[date.getMonth()]} ${date.getFullYear()}`;
};
const formattedListedAt = formatListedAt(listedAt);

// Datos del cast
const cast = people?.cast || [];
---

<Layout title={`${title} (${year})`}>
    <main class="min-h-screen mb-12">
        <!-- Hero con fanart de fondo -->
        <section
            class="relative h-[50vh] bg-cover bg-center bg-no-repeat"
            style={`background-image: url('${movieFanart || movieBanner}');`}
        >
            <!-- Overlay oscuro -->
            <div class="absolute inset-0 bg-linear-to-t from-zinc-900 via-zinc-900/70 to-transparent"></div>

            <!-- Contenido del hero -->
            <div class="absolute bottom-0 left-0 right-0 p-8">
                <div class="max-w-7xl mx-auto flex items-end gap-6">
                    <!-- Poster de la película -->
                    <figure class="shrink-0 hidden md:block">
                        <img
                            src={moviePoster}
                            alt={`Poster de ${title}`}
                            class="w-48 rounded-xl shadow-2xl border border-zinc-700"
                        />
                    </figure>

                    <!-- Info -->
                    <div class="flex-1">
                        {movieLogo ? (
                            <img
                                src={movieLogo}
                                alt={title}
                                class="h-16 md:h-24 mb-4 object-contain"
                            />
                        ) : (
                            <h1 class="text-3xl md:text-5xl font-bold text-white mb-2">{title}</h1>
                        )}
                        <div class="flex flex-wrap items-center gap-3 text-sm text-zinc-400">
                            {year && <span>{year}</span>}
                            {duration && <span>• {duration}</span>}
                            {certification && <span class="px-1.5 py-0.5 bg-zinc-700 rounded text-xs">{certification}</span>}
                            {rating && (
                                <span class="flex items-center gap-1 text-amber-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                    </svg>
                                    {rating}
                                </span>
                            )}
                        </div>
                        {genres.length > 0 && (
                            <div class="flex flex-wrap gap-2 mt-3">
                                {genres.slice(0, 5).map((genre: string) => (
                                    <span class="px-2 py-1 bg-zinc-800/80 rounded text-xs text-zinc-300 capitalize">
                                        {genre}
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </section>

        <!-- Contenido principal -->
        <section class="max-w-7xl mx-auto p-4 md:p-8">
            <!-- Poster en móvil -->
            <div class="md:hidden mb-6 flex justify-center">
                <img
                    src={moviePoster}
                    alt={`Poster de ${title}`}
                    class="w-48 rounded-xl shadow-2xl border border-zinc-700"
                />
            </div>

            <!-- Ratings externos -->
            {externalRatings && (
                <div class="flex flex-wrap gap-3 mb-8">
                    {externalRatings.imdb && (
                        <span class="flex items-center gap-1.5 rounded-lg bg-yellow-500/10 px-3 py-2 text-yellow-400 font-medium" title={`IMDB: ${externalRatings.imdbVotes} votos`}>
                            <IconIMDB width="20" height="20" />
                            {externalRatings.imdb}
                        </span>
                    )}
                    {externalRatings.rottenTomatoes && (
                        <span class="flex items-center gap-1.5 rounded-lg bg-red-500/10 px-3 py-2 text-red-400 font-medium" title="Rotten Tomatoes">
                            <IconRottenTomatoes width="20" height="20" />
                            {externalRatings.rottenTomatoes}
                        </span>
                    )}
                    {externalRatings.popcornmeter && (
                        <span class="flex items-center gap-1.5 rounded-lg bg-orange-500/10 px-3 py-2 text-orange-400 font-medium" title="Popcornmeter (Audiencia)">
                            <IconPopcorn width="20" height="20" />
                            {externalRatings.popcornmeter}
                        </span>
                    )}
                    {externalRatings.metascore && (
                        <span class="flex items-center gap-1.5 rounded-lg bg-amber-500/10 px-3 py-2 text-amber-300 font-medium" title="Metacritic">
                            <IconMetacritic width="20" height="20" />
                            {externalRatings.metascore}
                        </span>
                    )}
                    {rating && (
                        <span class="flex items-center gap-1.5 rounded-lg bg-purple-500/10 px-3 py-2 text-purple-400 font-medium" title="Trakt Rating">
                            <IconTrakt width="20" height="20" />
                            {rating}
                        </span>
                    )}
                </div>
            )}

            <!-- Datos locales (año visto, fecha agregado, rank) -->
            <div class="flex flex-wrap gap-4 mb-8 p-4 bg-zinc-800/50 rounded-xl">
                <div>
                    <span class="text-xs text-zinc-500 block">Año visto</span>
                    <span class="text-white font-medium">{yearViewed}</span>
                </div>
                {formattedListedAt && (
                    <div>
                        <span class="text-xs text-zinc-500 block">Agregada</span>
                        <span class="text-white font-medium">{formattedListedAt}</span>
                    </div>
                )}
                {rank && (
                    <div>
                        <span class="text-xs text-zinc-500 block">Posición</span>
                        <span class="text-white font-medium">#{rank}</span>
                    </div>
                )}
            </div>

            <!-- Overview -->
            {overview && (
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-white mb-3">Sinopsis</h2>
                    <p class="text-zinc-400 leading-relaxed">{overview}</p>
                </div>
            )}

            <!-- DEBUG: JSON completo -->
            <details class="mb-8 p-4 bg-zinc-800 rounded-lg border border-zinc-700">
                <summary class="cursor-pointer text-amber-400 font-semibold">DEBUG: Ver JSON completo</summary>
                <div class="mt-4 grid gap-4">
                    <div>
                        <h3 class="text-sm font-bold text-zinc-300 mb-2">Movie:</h3>
                        <pre class="text-xs text-zinc-400 overflow-auto max-h-64 p-2 bg-zinc-900 rounded">
                            {JSON.stringify(movie, null, 2)}
                        </pre>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-zinc-300 mb-2">People:</h3>
                        <pre class="text-xs text-zinc-400 overflow-auto max-h-64 p-2 bg-zinc-900 rounded">
                            {JSON.stringify(people, null, 2)}
                        </pre>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-zinc-300 mb-2">Local Data:</h3>
                        <pre class="text-xs text-zinc-400 overflow-auto max-h-64 p-2 bg-zinc-900 rounded">
                            {JSON.stringify(localData, null, 2)}
                        </pre>
                    </div>
                </div>
            </details>

            <!-- Volver -->
            <a
                href="/Movies"
                class="inline-flex items-center gap-2 text-zinc-400 hover:text-white transition-colors"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Volver a la lista
            </a>
        </section>
    </main>
</Layout>
