---
/**
 * Página dinámica para cada serie/temporada
 * URL: /Series/[idTrakt]-season-[numberSeason]
 * Ejemplo: /Series/loki-2021-season-2
 * Lee datos del caché local (sin llamadas API)
 */
import seriesCache from '../../data/cache/series.json';
import { getImageUrl } from '../../utils/images';
import Layout from '../../layouts/Layout.astro';
import IconArrowBack from '../../components/Icons/IconArrowBack.astro';
import IconStar from '../../components/Icons/IconStar.astro';
import IconUser from '../../components/Icons/IconUser.astro';
import IconPlayerPlay from '../../components/Icons/IconPlayerPlay.astro';

// Generar todas las rutas estáticas desde el caché (sin llamadas API)
export function getStaticPaths() {
    return (seriesCache.series as any[]).map((entry) => {
        const slug = `${entry.localData.idTrakt}-season-${entry.localData.numberSeason}`;
        return {
            params: { slug },
            props: {
                show: entry.show,
                season: entry.season,
                people: entry.people,
                episodes: entry.episodes || [],
                localData: entry.localData,
            },
        };
    });
}

// Props de la página
interface Props {
    show: any;
    season: any;
    people: any;
    episodes: any[];
    localData: {
        idTrakt: string;
        numberSeason: number;
        yearViewed: number;
        platformViewed: string;
        statusViewed: string;
    };
}

const { show, season, people, episodes: rawEpisodes, localData } = Astro.props;
const { idTrakt, numberSeason, yearViewed, platformViewed, statusViewed } = localData;

// Imágenes
const showPoster = getImageUrl(show?.images?.poster?.[0]);
const showFanart = getImageUrl(show?.images?.fanart?.[0]);
const showLogo = getImageUrl(show?.images?.logo?.[0]);
const showBanner = getImageUrl(show?.images?.banner?.[0]);
const seasonPoster = getImageUrl(season?.images?.poster?.[0]);
const seasonThumb = getImageUrl(season?.images?.thumb?.[0]);

// Datos de la serie
const title = show?.title || 'Sin título';
const year = show?.year;
const seasonTitle = season?.title || `Temporada ${numberSeason}`;
const overview = season?.overview || show?.overview || '';
const genres = show?.genres || [];
const network = show?.network;
const rating = show?.rating?.toFixed(1);
const seasonRating = season?.rating?.toFixed(1);

// Runtime por episodio y total de la temporada
const runtimePerEpisode = show?.runtime; // minutos por episodio
const episodeCount = season?.episode_count;
const totalSeasonMinutes = runtimePerEpisode && episodeCount ? runtimePerEpisode * episodeCount : null;

const formatRuntime = (minutes: number | undefined | null) => {
    if (!minutes) return null;
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
};
const episodeDuration = formatRuntime(runtimePerEpisode);
const seasonTotalDuration = formatRuntime(totalSeasonMinutes);

// Trailer
const trailerUrl: string | null = show?.trailer || null;
const trailerYoutubeId = trailerUrl?.match(/(?:v=|\/embed\/|youtu\.be\/)([a-zA-Z0-9_-]{11})/)?.[1] || null;

// Datos adicionales de la serie
const showStatus = show?.status;
const showLanguage = show?.language;
const showCountry = show?.country;
const showCertification = show?.certification;
const showFirstAired = show?.first_aired;
const showTagline = show?.tagline;
const showHomepage = show?.homepage;
const airedEpisodes = show?.aired_episodes;

// Formatear fecha
const formatDate = (dateString: string | null | undefined) => {
    if (!dateString) return null;
    const date = new Date(dateString);
    const day = date.getDate().toString().padStart(2, '0');
    const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun',
                    'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    return `${day} ${months[date.getMonth()]} ${date.getFullYear()}`;
};

// Formatear status
const formatStatus = (status: string | null | undefined) => {
    if (!status) return null;
    const map: Record<string, string> = {
        'returning series': 'En emisión',
        'continuing': 'En emisión',
        'in production': 'En producción',
        'planned': 'Planeada',
        'upcoming': 'Próximamente',
        'pilot': 'Piloto',
        'canceled': 'Cancelada',
        'ended': 'Finalizada',
    };
    return map[status] || status;
};

// Mapeo de códigos de idioma a nombres
const languageNames: Record<string, string> = {
    en: 'English', es: 'Español', ja: 'Japanese', ko: 'Korean',
    fr: 'Français', de: 'Deutsch', it: 'Italiano', pt: 'Português',
    zh: 'Chinese', ru: 'Russian', ar: 'Arabic', hi: 'Hindi',
    nl: 'Dutch', sv: 'Swedish', da: 'Danish', no: 'Norwegian',
    fi: 'Finnish', pl: 'Polish', tr: 'Turkish', th: 'Thai',
};

// Mapeo de códigos de país a nombres
const countryNames: Record<string, string> = {
    us: 'Estados Unidos', gb: 'Reino Unido', jp: 'Japón', kr: 'Corea del Sur',
    ca: 'Canadá', au: 'Australia', de: 'Alemania', fr: 'Francia',
    es: 'España', it: 'Italia', br: 'Brasil', mx: 'México',
    cn: 'China', in: 'India', ru: 'Rusia', nl: 'Países Bajos',
    se: 'Suecia', dk: 'Dinamarca', no: 'Noruega', fi: 'Finlandia',
    nz: 'Nueva Zelanda', ie: 'Irlanda', be: 'Bélgica', at: 'Austria',
    ch: 'Suiza', pl: 'Polonia', tr: 'Turquía', th: 'Tailandia',
    co: 'Colombia', ar: 'Argentina', cl: 'Chile', pe: 'Perú',
};

// Episodios de la temporada
const episodes = rawEpisodes || [];

// Datos del cast
const cast = people?.cast || [];

// Director(es) / Creador(es) de la serie
const directors = (people?.crew?.directing || [])
    .filter((d: any) => d.job === 'Director' || d.job === 'Series Director' || d.jobs?.includes('Director') || d.jobs?.includes('Series Director'))
    .map((d: any) => d.person?.name)
    .filter(Boolean);
const directorText = directors.length > 0 ? directors.join(', ') : null;

// Escritor(es) principal(es) de la serie
const writers = (people?.crew?.writing || [])
    .filter((d: any) => d.job === 'Series Composition' || d.job === 'Writer' || d.job === 'Creator' || d.jobs?.includes('Series Composition') || d.jobs?.includes('Writer') || d.jobs?.includes('Creator'))
    .map((d: any) => d.person?.name)
    .filter(Boolean);
const writerText = writers.length > 0 ? [...new Set(writers)].join(', ') : null;
---

<Layout title={`${title} - ${seasonTitle}`}>
    <main class="min-h-screen mb-12">
        <!-- Hero con fanart de fondo -->
        <section
            class="relative h-[67vh] bg-cover bg-center bg-no-repeat"
            style={`background-image: url('${showFanart || showBanner}');`}
        >
            <!-- Overlay oscuro -->
            <div class="absolute inset-0 bg-linear-to-t from-zinc-900 via-zinc-900/70 to-transparent"></div>

            <!-- Contenido del hero -->
            <div class="absolute bottom-0 left-0 right-0 p-8">
                <div class="max-w-7xl mx-auto flex flex-col items-center md:flex-row md:items-end gap-6">
                    <!-- Poster de la temporada -->
                    <figure class="shrink-0 hidden md:block">
                        <img
                            src={seasonPoster || showPoster}
                            alt={`Poster de ${title} ${seasonTitle}`}
                            class="w-48 rounded-xl shadow-2xl border border-zinc-700"
                            transition:name={`poster-series-${idTrakt}-s${numberSeason}`}
                        />
                    </figure>

                    <!-- Info -->
                    <div class="flex-1">
                        {showLogo ? (
                            <img
                                src={showLogo}
                                alt={title}
                                class="h-16 md:h-24 mb-4 object-contain"
                            />
                        ) : (
                            <h1 class="text-3xl md:text-5xl font-bold text-white mb-2">{title}</h1>
                        )}
                        <p class="text-xl md:text-2xl text-zinc-300 mb-2">{seasonTitle}</p>
                        <div class="flex flex-wrap items-center gap-3 text-sm text-zinc-400">
                            {year && <span>{year}</span>}
                            {network && <span>• {network}</span>}
                            {seasonRating && (
                                <span class="flex items-center gap-1 text-amber-400">
                                    <IconStar width={16} height={16} />
                                    {seasonRating}
                                </span>
                            )}
                        </div>
                        {genres.length > 0 && (
                            <div class="flex flex-wrap gap-2 mt-3">
                                {genres.slice(0, 5).map((genre: string) => (
                                    <span class="px-2 py-1 bg-zinc-800/80 rounded text-xs text-zinc-300 capitalize">
                                        {genre}
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </section>

        <!-- Contenido principal -->
        <section class="max-w-7xl mx-auto p-4 md:p-8">
            <!-- Poster en móvil -->
            <div class="md:hidden mb-6 flex justify-center">
                <img
                    src={seasonPoster || showPoster}
                    alt={`Poster de ${title} ${seasonTitle}`}
                    class="w-48 rounded-xl shadow-2xl border border-zinc-700"
                />
            </div>

            <!-- Datos locales (año visto, plataforma, estado) -->
            <div class="flex flex-wrap gap-4 mb-8 p-4 bg-zinc-800/50 rounded-xl">
                <div>
                    <span class="text-xs text-zinc-500 block">Año visto</span>
                    <span class="text-white font-medium">{yearViewed}</span>
                </div>
                <div>
                    <span class="text-xs text-zinc-500 block">Plataforma</span>
                    <span class="text-white font-medium capitalize">{platformViewed}</span>
                </div>
                <div>
                    <span class="text-xs text-zinc-500 block">Estado</span>
                    <span class:list={[
                        "font-medium capitalize",
                        statusViewed === 'completed' ? 'text-green-400' : 'text-amber-400'
                    ]}>
                        {statusViewed === 'completed' ? 'Completada' : 'En progreso'}
                    </span>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-xl font-bold text-white mb-3">Details</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-6 gap-y-3 text-sm">
                    {showStatus && (
                        <div>
                            <span class="text-zinc-500 block text-xs">Estado</span>
                            <span class:list={[
                                "font-medium",
                                showStatus === 'ended' || showStatus === 'canceled' ? 'text-zinc-300' : 'text-emerald-400'
                            ]}>{formatStatus(showStatus)}</span>
                        </div>
                    )}
                    {directorText && (
                        <div>
                            <span class="text-zinc-500 block text-xs">Director</span>
                            <span class="text-zinc-300 font-medium">{directorText}</span>
                        </div>
                    )}
                    {writerText && (
                        <div>
                            <span class="text-zinc-500 block text-xs">Guion</span>
                            <span class="text-zinc-300 font-medium">{writerText}</span>
                        </div>
                    )}
                    {season?.episode_count && (
                        <div>
                            <span class="text-zinc-500 block text-xs">Episodios</span>
                            <span class="text-zinc-300 font-medium">
                                {season.episode_count}
                                {episodeDuration && <span class="text-zinc-500"> ({episodeDuration}/ep)</span>}
                            </span>
                        </div>
                    )}
                    {seasonTotalDuration && (
                        <div>
                            <span class="text-zinc-500 block text-xs">Duracion total</span>
                            <span class="text-zinc-300 font-medium">{seasonTotalDuration}</span>
                        </div>
                    )}
                    {showCountry && (
                        <div>
                            <span class="text-zinc-500 block text-xs">Pais</span>
                            <span class="text-zinc-300 font-medium">{countryNames[showCountry] || showCountry.toUpperCase()}</span>
                        </div>
                    )}
                    {showLanguage && (
                        <div>
                            <span class="text-zinc-500 block text-xs">Idioma</span>
                            <span class="text-zinc-300 font-medium">{languageNames[showLanguage] || showLanguage.toUpperCase()}</span>
                        </div>
                    )}
                    {showCertification && (
                        <div>
                            <span class="text-zinc-500 block text-xs">Clasificacion</span>
                            <span class="text-zinc-300 font-medium">{showCertification}</span>
                        </div>
                    )}
                    {showFirstAired && (
                        <div>
                            <span class="text-zinc-500 block text-xs">Primera emision</span>
                            <span class="text-zinc-300 font-medium">{formatDate(showFirstAired)}</span>
                        </div>
                    )}
                    {network && (
                        <div>
                            <span class="text-zinc-500 block text-xs">Cadena</span>
                            <span class="text-zinc-300 font-medium">{network}</span>
                        </div>
                    )}
                </div>
                {showTagline && (
                    <p class="text-zinc-400 italic mt-3 text-sm">"{showTagline}"</p>
                )}
                {showHomepage && (
                    <a href={showHomepage} target="_blank" rel="noopener noreferrer" class="inline-block mt-2 text-xs text-blue-400 hover:text-blue-300 transition-colors">
                        Sitio oficial &rarr;
                    </a>
                )}
            </div>

            <!-- Overview -->
            {overview && (
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-white mb-3">Sinopsis</h2>
                    <p class="text-zinc-400 leading-relaxed">{overview}</p>
                </div>
            )}

            <!-- Reparto -->
            {cast.length > 0 && (
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-white mb-4">Reparto</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        {cast.slice(0, 12).map((member: any) => {
                            const headshot = getImageUrl(member.images?.headshot?.[0]);
                            const actorName = member.person?.name || 'Desconocido';
                            const characterName = member.character || '';
                            return (
                                <div class="group relative">
                                    <div class="aspect-[3/4] rounded-xl overflow-hidden bg-zinc-800/80 border border-zinc-700/40 shadow-lg shadow-black/20">
                                        {headshot ? (
                                            <img
                                                src={headshot}
                                                alt={actorName}
                                                class="w-full h-full object-cover object-top transition-all duration-500 group-hover:scale-110 group-hover:brightness-110"
                                                loading="lazy"
                                            />
                                        ) : (
                                            <div class="w-full h-full flex items-center justify-center bg-gradient-to-b from-zinc-700/30 to-zinc-800 text-zinc-600">
                                                <IconUser width={56} height={56} />
                                            </div>
                                        )}
                                        <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent p-3 pt-8">
                                            <p class="text-sm font-semibold text-white leading-tight truncate" title={actorName}>{actorName}</p>
                                            <p class="text-xs text-zinc-400 truncate mt-0.5" title={characterName}>{characterName}</p>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            )}

            <!-- Capitulos de la temporada -->
            {episodes.length > 0 && (
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-white mb-4">Capitulos <span class="text-zinc-500 text-base font-normal">({episodes.length})</span></h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        {episodes.map((ep: any) => {
                            const screenshot = getImageUrl(ep.images?.screenshot?.[0]);
                            const epTitle = ep.title || `Episodio ${ep.number}`;
                            const epDate = formatDate(ep.first_aired);
                            const epRating = ep.rating ? ep.rating.toFixed(1) : null;
                            return (
                                <div class="group bg-zinc-800/50 rounded-xl overflow-hidden border border-zinc-700/40 hover:border-zinc-600/60 transition-all duration-300">
                                    <div class="aspect-video relative overflow-hidden bg-zinc-800">
                                        {screenshot ? (
                                            <img
                                                src={screenshot}
                                                alt={epTitle}
                                                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                                                loading="lazy"
                                            />
                                        ) : (
                                            <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-zinc-700/30 to-zinc-800 text-zinc-600">
                                                <IconPlayerPlay width={40} height={40} />
                                            </div>
                                        )}
                                        <div class="absolute top-2 left-2 bg-black/70 backdrop-blur-sm px-2 py-0.5 rounded text-xs font-bold text-white">
                                            E{String(ep.number).padStart(2, '0')}
                                        </div>
                                        {epRating && (
                                            <div class="absolute top-2 right-2 bg-black/70 backdrop-blur-sm px-1.5 py-0.5 rounded text-xs text-amber-400 flex items-center gap-0.5">
                                                <IconStar width={12} height={12} />
                                                {epRating}
                                            </div>
                                        )}
                                    </div>
                                    <div class="p-3">
                                        <p class="text-sm font-semibold text-white leading-tight truncate" title={epTitle}>{epTitle}</p>
                                        {epDate && (
                                            <p class="text-xs text-zinc-500 mt-1">{epDate}</p>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            )}

            <!-- Trailer -->
            {trailerYoutubeId && (
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-white mb-4">Trailer</h2>
                    <div class="relative rounded-xl overflow-hidden border border-zinc-700/40 shadow-lg shadow-black/20 bg-black">
                        <div class="aspect-video">
                            <iframe
                                src={`https://www.youtube-nocookie.com/embed/${trailerYoutubeId}?rel=0&modestbranding=1`}
                                title={`Trailer de ${title}`}
                                class="w-full h-full"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen
                                loading="lazy"
                            />
                        </div>
                    </div>
                </div>
            )}

            <!-- DEBUG: JSON completo -->
            <!-- <details class="mb-8 p-4 bg-zinc-800 rounded-lg border border-zinc-700">
                <summary class="cursor-pointer text-amber-400 font-semibold">DEBUG: Ver JSON completo</summary>
                <div class="mt-4 grid gap-4">
                    <div>
                        <h3 class="text-sm font-bold text-zinc-300 mb-2">Show:</h3>
                        <pre class="text-xs text-zinc-400 overflow-auto max-h-64 p-2 bg-zinc-900 rounded">
                            {JSON.stringify(show, null, 2)}
                        </pre>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-zinc-300 mb-2">Season:</h3>
                        <pre class="text-xs text-zinc-400 overflow-auto max-h-64 p-2 bg-zinc-900 rounded">
                            {JSON.stringify(season, null, 2)}
                        </pre>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-zinc-300 mb-2">People:</h3>
                        <pre class="text-xs text-zinc-400 overflow-auto max-h-64 p-2 bg-zinc-900 rounded">
                            {JSON.stringify(people, null, 2)}
                        </pre>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-zinc-300 mb-2">Local Data:</h3>
                        <pre class="text-xs text-zinc-400 overflow-auto max-h-64 p-2 bg-zinc-900 rounded">
                            {JSON.stringify(localData, null, 2)}
                        </pre>
                    </div>
                </div>
            </details> -->


            <!-- Volver -->
            <a href="/Series" class="fixed bottom-18 right-4 bg-zinc-800 px-3 py-2 rounded-lg border border-zinc-700">
                <IconArrowBack width={24} height={24} />
            </a>
        </section>
    </main>
</Layout>
