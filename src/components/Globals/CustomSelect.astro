---
/**
 * CustomSelect - Select estilizado con dropdown personalizado
 *
 * Reemplaza el <select> nativo para control visual total.
 * Usa un botón trigger + lista desplegable posicionada.
 *
 * @example
 * <CustomSelect
 *     id="filter-year"
 *     label="Año"
 *     options={[{ value: "2026", label: "2026" }, { value: "2025", label: "2025" }]}
 *     defaultValue="2026"
 * />
 */

interface Option {
    value: string;
    label: string;
}

interface Props {
    id: string;
    label: string;
    options: Option[];
    defaultValue?: string;
    includeAll?: boolean;
    allLabel?: string;
    capitalize?: boolean;
}

const {
    id,
    label,
    options,
    defaultValue,
    includeAll = true,
    allLabel = "Todos",
    capitalize = false,
} = Astro.props;

// Determinar la opción seleccionada inicialmente
const allOptions = includeAll
    ? [{ value: "all", label: allLabel }, ...options]
    : options;

const initialValue = defaultValue || (includeAll ? "all" : options[0]?.value || "");
const initialLabel = allOptions.find(o => o.value === initialValue)?.label || allLabel;
---

<div class="custom-select-wrapper relative" data-select-id={id}>
    <label class="select-label" for={`${id}-trigger`}>{label}</label>
    <button
        type="button"
        id={`${id}-trigger`}
        class:list={[
            "select-trigger",
            { "select-capitalize": capitalize }
        ]}
        role="combobox"
        aria-expanded="false"
        aria-haspopup="listbox"
        aria-controls={`${id}-listbox`}
        data-value={initialValue}
    >
        <span class="select-trigger__label">{initialLabel}</span>
        <svg class="select-trigger__chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
    </button>

    <ul
        id={`${id}-listbox`}
        class="select-dropdown"
        role="listbox"
        aria-labelledby={`${id}-trigger`}
    >
        {allOptions.map((option) => (
            <li
                role="option"
                class:list={[
                    "select-option",
                    { "select-option--selected": option.value === initialValue },
                    { "select-capitalize": capitalize }
                ]}
                data-value={option.value}
                aria-selected={option.value === initialValue ? "true" : "false"}
            >
                <span class="select-option__label">{option.label}</span>
                <svg class="select-option__check" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </li>
        ))}
    </ul>

    <!-- Hidden input para mantener el valor accesible por ID (compatibilidad) -->
    <input type="hidden" id={id} name={id} value={initialValue} />
</div>

<style>
    .custom-select-wrapper {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
        position: relative;
    }

    .select-label {
        font-size: 10px;
        font-weight: 500;
        color: var(--color-zinc-500);
        letter-spacing: 0.02em;
        text-transform: uppercase;
        user-select: none;
    }

    .select-trigger {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        background: var(--color-zinc-800);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 8px;
        color: var(--color-zinc-200);
        font-size: 12px;
        font-family: inherit;
        cursor: pointer;
        white-space: nowrap;
        transition: border-color 150ms ease-out, background-color 150ms ease-out;
        min-width: 0;
        line-height: 1.4;
    }

    .select-trigger:hover {
        border-color: rgba(255, 255, 255, 0.12);
        background: var(--color-zinc-700);
    }

    .select-trigger:focus-visible {
        outline: none;
        border-color: rgb(136, 58, 234);
        box-shadow: 0 0 0 1px rgba(136, 58, 234, 0.3);
    }

    .select-trigger[aria-expanded="true"] {
        border-color: rgba(255, 255, 255, 0.12);
        background: var(--color-zinc-700);
    }

    .select-trigger[aria-expanded="true"] .select-trigger__chevron {
        transform: rotate(180deg);
    }

    .select-trigger__label {
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .select-trigger__chevron {
        flex-shrink: 0;
        color: var(--color-zinc-400);
        transition: transform 150ms ease-out;
    }

    .select-dropdown {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        z-index: 50;
        min-width: 100%;
        max-height: 240px;
        overflow-y: auto;
        background: var(--color-zinc-800);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        padding: 4px;
        list-style: none;
        margin: 0;

        /* Hidden by default */
        opacity: 0;
        visibility: hidden;
        transform: translateY(-4px);
        transition: opacity 150ms ease-out, transform 150ms ease-out, visibility 150ms ease-out;

        /* Scrollbar styling */
        scrollbar-width: thin;
        scrollbar-color: var(--color-zinc-600) transparent;
    }

    .select-dropdown.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .select-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 6px 8px;
        border-radius: 6px;
        font-size: 12px;
        color: var(--color-zinc-300);
        cursor: pointer;
        transition: background-color 100ms ease-out, color 100ms ease-out;
        user-select: none;
    }

    .select-option:hover {
        background: rgba(255, 255, 255, 0.06);
        color: var(--color-zinc-100);
    }

    .select-option--selected {
        color: rgb(167, 139, 250);
    }

    .select-option__check {
        flex-shrink: 0;
        opacity: 0;
        color: rgb(167, 139, 250);
        transition: opacity 100ms ease-out;
    }

    .select-option--selected .select-option__check {
        opacity: 1;
    }

    .select-capitalize {
        text-transform: capitalize;
    }

    /* Dropdown scrollbar for webkit */
    .select-dropdown::-webkit-scrollbar {
        width: 4px;
    }
    .select-dropdown::-webkit-scrollbar-track {
        background: transparent;
    }
    .select-dropdown::-webkit-scrollbar-thumb {
        background: var(--color-zinc-600);
        border-radius: 4px;
    }
</style>
