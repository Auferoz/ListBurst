---
/**
 * FilterBar - Componente global reutilizable para filtros
 *
 * Genera una barra de filtros con <select> nativos estilizados.
 * Dispara eventos `filter-change` y `filter-reset` en el document
 * para que cada página gestione su lógica de filtrado.
 *
 * La config de IDs y defaults se pasa al script via data-* attributes
 * en el elemento raíz, evitando `define:vars` (incompatible con View Transitions).
 *
 * @example
 * <FilterBar
 *     filters={[
 *         { id: "filter-year", label: "Año", options: yearOptions, defaultValue: "2026" },
 *         { id: "filter-genre", label: "Género", options: genreOptions, capitalize: true },
 *         { id: "filter-order", label: "Orden", options: orderOptions, defaultValue: "newest", includeAll: false },
 *     ]}
 * />
 */

interface FilterOption {
    value: string;
    label: string;
}

interface FilterConfig {
    id: string;
    label: string;
    options: FilterOption[];
    defaultValue?: string;
    includeAll?: boolean;
    allLabel?: string;
    capitalize?: boolean;
}

interface Props {
    filters: FilterConfig[];
}

const { filters } = Astro.props;

// Preparar config para pasar al script via data attributes
const filterIds = filters.map(f => f.id);
const filterDefaults: Record<string, string> = {};
filters.forEach(f => {
    filterDefaults[f.id] = f.defaultValue || (f.includeAll !== false ? "all" : f.options[0]?.value || "");
});
---

<section
    class="relative mt-4"
    id="filters"
    data-filter-ids={JSON.stringify(filterIds)}
    data-filter-defaults={JSON.stringify(filterDefaults)}
>
    <div class="flex flex-wrap items-end gap-2.5">
        {filters.map((filter) => (
            <div class="flex flex-col items-start gap-1">
                <label
                    for={filter.id}
                    class="text-[10px] font-medium text-zinc-500 uppercase tracking-wide select-none"
                >
                    {filter.label}
                </label>
                <select
                    id={filter.id}
                    class:list={[
                        "filter-select appearance-none cursor-pointer font-inherit",
                        "bg-zinc-800 text-zinc-200 text-xs leading-snug",
                        "border border-white/6 rounded-lg",
                        "py-1.5 pl-2.5 pr-7",
                        "bg-no-repeat bg-[length:12px] bg-[position:right_8px_center]",
                        "transition-[border-color,background-color] duration-150 ease-out",
                        "hover:border-white/12 hover:bg-zinc-700",
                        "focus-visible:outline-none focus-visible:border-violet-500 focus-visible:shadow-[0_0_0_1px_rgba(136,58,234,0.3)]",
                        { "capitalize": filter.capitalize }
                    ]}
                    style="background-image: url(&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E&quot;);"
                >
                    {filter.includeAll !== false && (
                        <option
                            value="all"
                            selected={!filter.defaultValue || filter.defaultValue === "all"}
                        >
                            {filter.allLabel || "Todos"}
                        </option>
                    )}
                    {filter.options.map((option) => (
                        <option
                            value={option.value}
                            selected={option.value === filter.defaultValue}
                        >
                            {option.label}
                        </option>
                    ))}
                </select>
            </div>
        ))}

        <!-- Botón Reset -->
        <div class="flex flex-col items-start gap-1">
            <span class="text-[10px] font-medium text-zinc-500 uppercase tracking-wide select-none">
                Reset
            </span>
            <button
                id="filter-reset"
                type="button"
                class="inline-flex items-center justify-center w-8 h-[30px] bg-transparent border border-transparent rounded-lg text-zinc-500 cursor-pointer transition-[color,border-color,background-color] duration-150 ease-out hover:text-red-400 hover:border-red-400/20 hover:bg-red-400/6 focus-visible:outline-none focus-visible:border-red-400/40 focus-visible:shadow-[0_0_0_1px_rgba(248,113,113,0.2)]"
                aria-label="Resetear filtros"
            >
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="1 4 1 10 7 10"></polyline>
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Indicador de filtros activos -->
    <div
        id="filter-active-indicator"
        class="absolute -bottom-1.5 left-0 right-0 h-px rounded-sm bg-white/4 transition-[background,box-shadow] duration-300 ease-out"
    ></div>
</section>

<script>
    let controller: AbortController | null = null;

    function initFilterBar() {
        // Cleanup listeners previos (View Transitions)
        if (controller) controller.abort();
        controller = new AbortController();
        const { signal } = controller;

        const filtersSection = document.getElementById('filters');
        if (!filtersSection) return;

        // Leer config desde data attributes
        const filterIds: string[] = JSON.parse(filtersSection.dataset.filterIds || '[]');
        const filterDefaults: Record<string, string> = JSON.parse(filtersSection.dataset.filterDefaults || '{}');
        const resetBtn = document.getElementById('filter-reset');
        const indicator = document.getElementById('filter-active-indicator');

        // Escuchar change en cada select
        filterIds.forEach(id => {
            const select = document.getElementById(id) as HTMLSelectElement | null;
            if (select) {
                select.addEventListener('change', () => emitFilterChange(), { signal });
            }
        });

        // Reset
        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                filterIds.forEach(id => {
                    const select = document.getElementById(id) as HTMLSelectElement | null;
                    if (select) select.value = filterDefaults[id];
                });
                emitFilterChange();
                document.dispatchEvent(new CustomEvent('filter-reset'));
            }, { signal });
        }

        function emitFilterChange() {
            const values: Record<string, string> = {};
            filterIds.forEach(id => {
                const select = document.getElementById(id) as HTMLSelectElement | null;
                if (select) values[id] = select.value;
            });

            document.dispatchEvent(new CustomEvent('filter-change', { detail: values }));
            updateIndicator(values);
        }

        function updateIndicator(values: Record<string, string>) {
            const hasActive = filterIds.some(id => values[id] !== filterDefaults[id]);
            if (indicator) {
                indicator.classList.toggle('active', hasActive);
            }
        }

        // Indicador visual inicial
        const initialValues: Record<string, string> = {};
        filterIds.forEach(id => {
            const select = document.getElementById(id) as HTMLSelectElement | null;
            if (select) initialValues[id] = select.value;
        });
        updateIndicator(initialValues);
    }

    document.addEventListener('astro:page-load', initFilterBar);
</script>

<style>
    /* Indicador activo - solo esto necesita CSS custom por el glow */
    .active {
        background: rgba(136, 58, 234, 0.4) !important;
        box-shadow: 0 0 8px rgba(136, 58, 234, 0.15);
    }
</style>
