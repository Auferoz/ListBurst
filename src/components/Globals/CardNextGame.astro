---
import IconSteam from '../Icons/IconSteam.astro';

/**
 * CardNextGame - Card horizontal para juegos de próximo lanzamiento
 *
 * Layout mobile-first: poster izquierda, info derecha, artwork de fondo.
 * Estilo consistente con CardGamesList.astro.
 */

interface IGDBData {
    id: number;
    name: string;
    slug: string;
    url: string;
    summary: string | null;
    firstReleaseDate: number | null;
    cover: string | null;
    genres: string[];
    platforms: string[];
    screenshots: string[];
    artworks: string[];
    releaseDates: { human: string; date?: number; platform: string | null }[];
    developers: string[];
    publishers: string[];
    steamUrl: string | null;
}

interface Props {
    data: {
        localData: {
            title: string;
            poster: string;
            dateRelease: string;
        };
        igdb: IGDBData | null;
        inMyList?: boolean;
    };
}

const { data } = Astro.props;

const title = data.localData.title;
const poster = data.localData.poster;
const igdb = data.igdb;
const inMyList = data.inMyList ?? false;

// Parsear fecha DD-MM-YYYY
const [day, month, year] = data.localData.dateRelease.split('-').map(Number);
const releaseDate = new Date(year, month - 1, day);
const now = new Date();

// Calcular días restantes
const diffMs = releaseDate.getTime() - now.getTime();
const daysLeft = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

// Determinar si es TBA (31-12-YYYY sin fecha exacta conocida)
const isTBA = day === 31 && month === 12;

// Determinar si ya se lanzó
const isReleased = daysLeft <= 0 && !isTBA;

// Categorizar proximidad para estilo visual
const proximity = (() => {
    if (isTBA) return 'tba';
    if (isReleased) return 'released';
    if (daysLeft <= 30) return 'imminent';
    if (daysLeft <= 90) return 'soon';
    return 'distant';
})();

// Clases de borde según proximidad (mismo patrón que CardGamesList)
const borderClasses: Record<string, string> = {
    released: 'border-emerald-700/50 shadow-emerald-700/20 hover:shadow-emerald-700/40',
    imminent: 'border-amber-600/50 shadow-amber-600/20 hover:shadow-amber-600/40',
    soon: 'border-sky-700/50 shadow-sky-700/20 hover:shadow-sky-700/40',
    distant: 'border-zinc-700/50 shadow-zinc-700/10 hover:shadow-zinc-700/30',
    tba: 'border-zinc-700/30 shadow-zinc-800/10 hover:shadow-zinc-800/20',
};

// Color del texto del countdown según proximidad
const countdownClasses: Record<string, string> = {
    released: 'text-emerald-400',
    imminent: 'text-amber-300',
    soon: 'text-sky-400',
    distant: 'text-zinc-400',
    tba: 'text-zinc-500',
};

// Texto del countdown
const countdownText = (() => {
    if (isTBA) return 'TBA';
    if (isReleased) return 'Disponible';
    if (daysLeft === 1) return '1 día';
    return `${daysLeft}d`;
})();

// Formatear fecha para mostrar
const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
const formattedDate = isTBA
    ? `${year}`
    : `${day} ${monthNames[month - 1]} ${year}`;

// ISO date para el script de countdown
const isoDate = releaseDate.toISOString();

// Datos IGDB extraídos
const genres = igdb?.genres?.slice(0, 2) || [];
const developer = igdb?.developers?.[0] || null;
const platforms = igdb?.platforms || [];
const steamUrl = igdb?.steamUrl || null;

// Artwork de fondo: screenshot o artwork de IGDB
const bgImageId = igdb?.screenshots?.[0] || igdb?.artworks?.[0] || null;
const bgImageUrl = bgImageId
    ? `https://images.igdb.com/igdb/image/upload/t_screenshot_big/${bgImageId}.webp`
    : null;

// Mapear plataformas a abreviaciones compactas
const platformAbbrev: Record<string, string> = {
    'PC (Microsoft Windows)': 'PC',
    'PlayStation 5': 'PS5',
    'PlayStation 4': 'PS4',
    'Xbox Series X|S': 'XSX',
    'Xbox One': 'XB1',
    'Nintendo Switch': 'NSW',
    'Nintendo Switch 2': 'NSW2',
    'Mac': 'Mac',
    'Linux': 'Linux',
};
const platformTags = platforms
    .map((p) => platformAbbrev[p] || null)
    .filter(Boolean)
    .slice(0, 4);

// Barra de progreso
const showProgress = !isTBA && !isReleased && daysLeft <= 365;
const progressPercent = showProgress
    ? Math.max(2, Math.min(100, ((365 - daysLeft) / 365) * 100))
    : 0;
const progressColor = proximity === 'imminent'
    ? 'bg-amber-400/70'
    : proximity === 'soon'
        ? 'bg-sky-400/50'
        : 'bg-zinc-600/50';
---

<article
    class:list={[
        "card-next-game group relative flex items-stretch overflow-hidden rounded-xl border shadow-lg transition-shadow",
        inMyList ? "border-l-2 border-l-emerald-500" : "",
        borderClasses[proximity],
    ]}
    data-release-date={isoDate}
    data-is-tba={isTBA ? 'true' : 'false'}
    data-in-my-list={inMyList ? 'true' : 'false'}
>
    <!-- Background artwork con mask (derecha a izquierda) -->
    {bgImageUrl && (
        <div
            class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-30"
            style={`background-image: url('${bgImageUrl}'); mask-image: linear-gradient(to left, rgba(0,0,0,1) 0%, rgba(0,0,0,0.3) 60%, rgba(0,0,0,0) 100%); -webkit-mask-image: linear-gradient(to left, rgba(0,0,0,1) 0%, rgba(0,0,0,0.3) 60%, rgba(0,0,0,0) 100%);`}
        />
    )}
    <!-- Overlay oscuro -->
    <div class="absolute inset-0 bg-linear-to-r from-zinc-900/95 via-zinc-900/80 to-zinc-900/60"></div>

    <!-- Contenido -->
    <div class="relative z-10 flex w-full gap-3 p-2">
        <!-- Poster -->
        <figure class="shrink-0">
            <img
                class="h-28 w-auto rounded-lg object-cover shadow-md"
                src={poster}
                alt={`Poster de ${title}`}
                loading="lazy"
            />
        </figure>

        <!-- Info -->
        <div class="flex flex-1 flex-col justify-between py-0.5 min-w-0">
            <header>
                <div class="flex items-start justify-between gap-2">
                    <h3 class="text-sm font-semibold text-white leading-tight line-clamp-2 flex items-center gap-1">
                        {inMyList && (
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 shrink-0 text-emerald-400" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M5 2h14a1 1 0 0 1 1 1v19.143a.5.5 0 0 1-.766.424L12 18.03l-7.234 4.536A.5.5 0 0 1 4 22.143V3a1 1 0 0 1 1-1z"/>
                            </svg>
                        )}
                        <span>{title}</span>
                    </h3>
                    <span
                        class:list={[
                            "countdown-badge shrink-0 text-xs font-bold tabular-nums",
                            countdownClasses[proximity],
                        ]}
                        data-days-left={daysLeft}
                    >
                        {countdownText}
                    </span>
                </div>
                {developer && (
                    <p class="text-[11px] text-zinc-500 mt-0.5 truncate">{developer}</p>
                )}
                {genres.length > 0 && (
                    <p class="text-[11px] text-zinc-400 mt-0.5 truncate capitalize">
                        {genres.join(', ')}
                    </p>
                )}
            </header>

            <!-- Footer -->
            <footer class="flex items-center gap-2 text-xs mt-auto">
                <time class="text-zinc-500 tabular-nums" datetime={isoDate}>
                    {formattedDate}
                </time>

                {steamUrl && (
                    <a
                        href={steamUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="steam-link inline-flex items-center justify-center text-zinc-500 transition-colors duration-150 hover:text-[#66c0f4]"
                        title="Ver en Steam"
                        aria-label={`Ver ${title} en Steam`}
                    >
                        <IconSteam width={14} height={14} />
                    </a>
                )}

                {platformTags.length > 0 && (
                    <div class="flex items-center gap-1 ml-auto">
                        {platformTags.map((tag) => (
                            <span class="rounded-full bg-zinc-800/80 px-2 py-0.5 text-[10px] font-medium text-zinc-400">
                                {tag}
                            </span>
                        ))}
                    </div>
                )}
            </footer>
        </div>
    </div>

    <!-- Barra de progreso abajo -->
    {showProgress && (
        <div class="absolute bottom-0 inset-x-0 h-0.5 bg-zinc-800">
            <div
                class:list={["h-full transition-all duration-1000", progressColor]}
                style={`width: ${progressPercent}%`}
            />
        </div>
    )}
</article>
