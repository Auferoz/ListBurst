---
import { getGameSlug } from '../../data/gamesDB';

/**
 * Props: recibe el objeto completo del juego desde gamesDB
 *
 * data.title: Nombre del juego
 * data.released: Fecha de lanzamiento (DD/MM/YYYY)
 * data.companie: Desarrollador/Publisher
 * data.poster: ID de imagen IGDB (ej: "co1xwu.webp")
 * data.genre: Géneros separados por coma
 * data.estado: Completado/Abandonado/Jugando
 * data.horasTotal: Horas totales jugadas
 * data.logros_obt: Logros obtenidos
 * data.logros_total: Total de logros
 * data.console_pc: Plataforma
 * data.igdbId: ID de IGDB
 * data.first_year_played: Año en que se jugó por primera vez
 * data.years_played: Booleanos por año
 * data.description: Descripción del juego
 */
interface Props {
    data: {
        title: string;
        released: string;
        companie: string;
        poster: string;
        artworks?: string;
        genre: string;
        estado: string;
        horasTotal: number;
        logros_obt: number;
        logros_total: number;
        console_pc: string;
        igdbId: number;
        first_year_played: number;
        years_played: Record<string, boolean>;
        description: string;
    };
    index?: number;
}

const { data, index = 0 } = Astro.props;

// Imagen del juego desde IGDB CDN
const posterUrl = `https://images.igdb.com/igdb/image/upload/t_cover_big/${data.poster}`;

// imagen de fondo (artworks) desde IGDB CDN
const artworks = data.artworks ? `https://images.igdb.com/igdb/image/upload/t_cover_big/${data.artworks}` : null;

// Datos derivados
const title = data.title || 'Sin título';
const genres = data.genre ? data.genre.split(',').map(g => g.trim()) : [];
const platform = data.console_pc;
const estado = data.estado;
const hours = data.horasTotal;
const companie = data.companie;

// Extraer año de release desde formato DD/MM/YYYY
const releaseYear = data.released ? data.released.split('/')[2] : null;

// Años en que se jugó (para data attribute de filtrado)
const yearsPlayed = Object.entries(data.years_played)
    .filter(([_, played]) => played)
    .map(([key]) => key.replace('y', ''))
    .join(',');

// URL de detalle
const slug = getGameSlug(data.title);
const detailUrl = `/Games/${slug}`;

// Clases de color según el estado
const statusColorClasses = (() => {
    switch (estado) {
        case 'Jugando':
            return 'border-green-700/50 shadow-green-700/20 hover:shadow-green-700/40';
        case 'Completado':
            return 'border-sky-700/50 shadow-sky-700/20 hover:shadow-sky-700/40';
        case 'Abandonado':
            return 'border-zinc-600/50 shadow-zinc-600/20 hover:shadow-zinc-600/40';
        default:
            return 'border-sky-700/50 shadow-sky-700/20 hover:shadow-sky-700/40';
    }
})();
---

<a
    href={detailUrl}
    class:list={[
        "card-game block group relative flex items-stretch overflow-hidden rounded-xl border shadow-lg transition-shadow",
        statusColorClasses
    ]}
    data-year={yearsPlayed}
    data-genres={genres.join(',').toLowerCase()}
    data-estado={estado.toLowerCase()}
    data-platform={platform.toLowerCase()}
    data-index={index}
    data-title={title.toLowerCase()}
    data-hours={hours}
>
    <!-- Background Image with Mask (usando movieFanart o movieBanner) -->
    <div
        class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-40"
        style={`background-image: url('${artworks ? artworks : ''}'); mask-image: linear-gradient(to left, rgba(0,0,0,1) 0%, rgba(0,0,0,0.3) 60%, rgba(0,0,0,0) 100%); -webkit-mask-image: linear-gradient(to left, rgba(0,0,0,1) 0%, rgba(0,0,0,0.3) 60%, rgba(0,0,0,0) 100%);`}
    ></div>
    <!-- Dark Overlay background -->
    <div class="absolute inset-0 bg-linear-to-r from-zinc-900/95 via-zinc-900/80 to-zinc-900/60"></div>

    <!-- Content Container -->
    <div class="relative z-10 flex w-full gap-3 p-2">
        <!-- Poster Image -->
        <figure class="shrink-0">
            <img
                class="h-28 w-auto rounded-lg object-cover shadow-md"
                src={posterUrl}
                alt={`Poster de ${title}`}
                loading="lazy"
                transition:name={`poster-game-${slug}`}
            />
        </figure>

        <!-- Info Section -->
        <div class="flex flex-1 flex-col justify-between py-1">
            <header>
                <h3 class="text-base font-semibold text-white leading-tight">
                    {title}
                    {releaseYear && <span class="text-xs text-zinc-400">({releaseYear})</span>}
                </h3>
                <p class="text-xs text-zinc-500 mt-0.5">
                    {companie}
                </p>
                {genres.length > 0 && (
                    <p class="text-xs text-zinc-400 mt-0.5 capitalize">
                        {genres.slice(0, 3).join(', ')}
                    </p>
                )}
            </header>

            <!-- Footer -->
            <footer class="flex items-center gap-2 text-xs">
                <span class="rounded-full bg-zinc-800/80 px-2.5 py-1 text-zinc-300 font-medium">
                    {platform}
                </span>
                {hours > 0 && (
                    <span class="text-zinc-500">
                        {hours}h
                    </span>
                )}
                {/* Icono de estado */}
                {estado === 'Completado' && (
                    <span class="ml-auto text-violet-400" title="Completado">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </span>
                )}
                {estado === 'Jugando' && (
                    <span class="ml-auto text-green-400" title="Jugando">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                            <polygon points="6 4 20 12 6 20"></polygon>
                        </svg>
                    </span>
                )}
                {estado === 'Abandonado' && (
                    <span class="ml-auto text-red-400" title="Abandonado">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </span>
                )}
            </footer>
        </div>

        <!-- Game page detail link -->
        <span
            class="absolute top-2 right-2 p-1 text-zinc-200 hover:text-white transition-colors"
            aria-label={`Ver detalle de ${title}`}
        >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="5" r="2"></circle>
                <circle cx="12" cy="12" r="2"></circle>
                <circle cx="12" cy="19" r="2"></circle>
            </svg>
        </span>
    </div>
</a>
